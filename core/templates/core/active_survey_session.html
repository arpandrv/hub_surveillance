{% extends 'core/base.html' %}

{% block title %}Active Survey: {{ farm.name }}{% endblock %}

{% block heading %}Survey in Progress: {{ farm.name }}{% endblock %}

{% block head_extra %}
{# Add Leaflet CSS if we add a map later #}
{# <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/> #}
<style>
  /* Basic styling for layout */
  .observation-form-area {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: .375rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .progress-tracker {
    margin-bottom: 1.5rem;
  }
</style>
{% endblock head_extra %}

{% block content %}
<div class="row">

  {# --- Left Column: Info & Progress --- #}
  <div class="col-md-4">
    {# Session Info Card #}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
           <i class="bi bi-info-circle me-1"></i> Session Details
        </div>
        <div class="card-body">
            <p><strong>Farm:</strong> {{ farm.name }}</p>
            <p><strong>Surveyor:</strong> {{ session.surveyor.username }}</p>
            <p><strong>Started:</strong> {{ session.start_time|date:"M j, Y, P" }}</p>
            <p><strong>Status:</strong> <span class="badge bg-warning text-dark">{{ session.get_status_display }}</span></p>
        </div>
    </div>

    {# Progress Tracker #}
    <div class="card mb-4 shadow-sm progress-tracker">
        <div class="card-header bg-secondary text-white">
            <i class="bi bi-graph-up me-1"></i> Progress
        </div>
        <div class="card-body">
            {% with completed=completed_plants target=target_plants|default:0 pests=unique_pests_count diseases=unique_diseases_count %}
            <p>Observations Recorded: <strong id="completed-obs-count">{{ completed }}</strong></p>
            {% if target > 0 %}
                <p>Target Observations: <strong>{{ target }}</strong></p>
                 <div class="progress mb-3" role="progressbar" aria-label="Survey Progress" aria-valuenow="{{ completed }}" aria-valuemin="0" aria-valuemax="{{ target }}">
                    <div class="progress-bar" style="width: {{ completion_percentage }}%;">
                        {{ completed }}/{{ target }}
                    </div>
                </div>
            {% else %}
                <p class="text-muted small mb-3">Target not set (no calculation found).</p>
            {% endif %}
            {# --- Display Unique Pest/Disease Counts --- #}
            <p class="mb-1"><i class="bi bi-bug-fill text-danger me-1"></i> Unique Pests Found: <strong id="unique-pests-count">{{ pests }}</strong></p>
            <p class="mb-0"><i class="bi bi-virus text-warning me-1"></i> Unique Diseases Found: <strong id="unique-diseases-count">{{ diseases }}</strong></p>
            {% endwith %}
        </div>
    </div>

    {# Recommendations Card #}
    <div class="card border-info shadow-sm">
        <div class="card-header bg-info text-white">
            <i class="bi bi-stars me-1"></i> Stage Recommendations
        </div>
        <div class="card-body small">
             <p class="text-muted mb-2">Current Stage: <strong>{{ current_stage_name|default:'Unknown' }}</strong></p>
            {% if recommended_pests %}
                <strong>Priority Pests:</strong>
                <ul class="list-inline">{% for p in recommended_pests %}<li class="list-inline-item"><span class="badge bg-danger-subtle text-danger-emphasis">{{ p.name }}</span></li>{% endfor %}</ul>
            {% endif %}
            {% if recommended_diseases %}
                <strong>Priority Diseases:</strong>
                <ul class="list-inline">{% for d in recommended_diseases %}<li class="list-inline-item"><span class="badge bg-warning-subtle text-warning-emphasis">{{ d.name }}</span></li>{% endfor %}</ul>
            {% endif %}
        </div>
    </div>
  </div>

  {# --- Right Column: Observation Form & List --- #}
  <div class="col-md-8">
    
    {# Observation Recording Form Area #}
    <div class="observation-form-area">
        <h4><i class="bi bi-geo-alt-fill me-1"></i> Record New Observation</h4>
        <p class="text-muted small">Ensure GPS is enabled and stable before saving each observation.</p>
        <hr>
        
        {# GPS Status Area - Improved Structure #}
        <div id="gps-status" class="alert alert-secondary small mb-3 d-flex align-items-center">
            <span id="gps-icon" class="me-2"><i class="bi bi-hourglass-split"></i></span> {# Placeholder Icon #}
            <span id="gps-text">Acquiring GPS signal...</span> {# Placeholder Text #}
        </div>
        <div id="gps-error-message" class="alert alert-danger small mb-3" style="display: none;"></div>

        {# Tutorial/Help Placeholder #}
        <div class="alert alert-info alert-dismissible fade show small mb-3" role="alert">
            <i class="bi bi-lightbulb me-1"></i> <strong>Tip:</strong> Select observed pests/diseases, add notes or photos, and save before moving to the next plant.
            <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        {# Render the Observation Form #}
        {% if form %}
            {# Add session_id to the form tag data attribute for easy JS access #}
            <form id="observation-form" method="post" enctype="multipart/form-data" data-session-id="{{ session.session_id }}">
                {% csrf_token %}
                {# Hidden fields for GPS data #}
                <input type="hidden" name="latitude" id="id_latitude">
                <input type="hidden" name="longitude" id="id_longitude">
                <input type="hidden" name="gps_accuracy" id="id_gps_accuracy">
                
                {# Render fields manually for better control #}
                {# Hide Plant Sequence Number - Will be set automatically #}
                {# Hidden field for plant_sequence_number #}
                <input type="hidden" id="id_plant_sequence_number" name="plant_sequence_number" value="">
                {% if form.plant_sequence_number.errors %}
                <div class="alert alert-danger small" id="sequence-number-error" style="display: none;">
                    {% for error in form.plant_sequence_number.errors %}{{ error }}{% endfor %}
                </div>
                {% endif %}

                <div class="mb-3">
                    <label class="form-label">{{ form.pests_observed.label }}</label>
                    <div class="form-check-scrollable border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                        {{ form.pests_observed }}
                    </div>
                    {% for error in form.pests_observed.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ form.diseases_observed.label }}</label>
                    <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                        {{ form.diseases_observed }}
                    </div>
                    {% for error in form.diseases_observed.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>

                {# Collapsible Notes #}
                <div class="mb-3">
                    <a class="btn btn-outline-secondary btn-sm mb-1" data-bs-toggle="collapse" href="#collapseNotes" role="button" aria-expanded="false" aria-controls="collapseNotes">
                        <i class="bi bi-pencil-square me-1"></i> Add/View Notes (Optional)
                    </a>
                    <div class="collapse" id="collapseNotes">
                      <div class="card card-body p-2">
                         {{ form.notes.label_tag }}
                         {{ form.notes }}
                         {% for error in form.notes.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                      </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Upload Images (Optional)</label>
                    
                    <input type="file" id="fileElem" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
                    <button type="button" id="fileSelect" class="btn btn-primary">Select Images to Upload</button>
                    
                    <small class="form-text text-muted d-block mt-2">You can select multiple images at once.</small>
                    
                    <div id="gallery" class="mt-3 d-flex flex-wrap gap-2">
                        <!-- Images will appear here -->
                    </div>
                    
                    <div id="fileList" class="mt-2">
                        <p>No files selected!</p>
                    </div>
                </div>

                <button type="submit" id="save-observation-btn" class="btn btn-success" disabled>
                     {# ADDED: Spinner (initially hidden) #}
                     <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span>
                     <i class="bi bi-check-lg me-1"></i> 
                     <span class="button-text">Save Observation at Current Location</span>
                </button>
                <span id="save-status" class="ms-2"></span> {# For showing save status #}
                <span id="auto-save-status" class="ms-2 text-muted small"></span> {# For showing auto-save status #}
            </form>
        {% else %}
            {# This message should now only appear if the form is genuinely missing from the context #}
            <p class="text-danger">Observation form could not be loaded.</p> 
        {% endif %}
        
        {# Explicit Warning #}
        <div class="alert alert-warning small mt-3 p-2" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-1"></i> <strong>Important:</strong> Press 'Save Observation' *before* moving to the next plant to ensure accurate GPS logging for each observation.
        </div>
    </div>

    {# Finish Session Button #}
    <div class="text-end mb-4">
        <button id="finish-session-btn" class="btn btn-lg btn-primary" disabled>
            <i class="bi bi-flag-fill me-1"></i> Finish Survey Session
        </button>
        <small class="d-block text-muted">(Requires {{ target_plants|default:0 }} observations)</small>
    </div>

    {# List of Previous Observations #}
    <div class="card shadow-sm">
        <div class="card-header bg-light">
           <i class="bi bi-list-ul me-1"></i> 
           Observations in this Session (<span id="observation-count">{{ observations.count }}</span>)
        </div>
        {# Add an ID to the list for easy JS targeting #}
        <ul id="observation-list" class="list-group list-group-flush">
            {% for obs in observations|slice:":10" %} {# Show latest 10 initially #}
            {# Use include tag or duplicate structure here #}
            <li class="list-group-item" data-observation-id="{{ obs.id }}">
                <strong>Time:</strong> {{ obs.observation_time|date:"P" }} 
                <small>({{ obs.latitude|floatformat:5 }}, {{ obs.longitude|floatformat:5 }})</small>
                <br>
                {% if obs.pests_observed.all %} Pests: {% for pest in obs.pests_observed.all %}<span class="badge bg-danger-subtle text-danger-emphasis me-1">{{ pest.name }}</span>{% endfor %}<br>{% endif %}
                {% if obs.diseases_observed.all %} Diseases: {% for disease in obs.diseases_observed.all %}<span class="badge bg-warning-subtle text-warning-emphasis me-1">{{ disease.name }}</span>{% endfor %}<br>{% endif %}
                {% if obs.notes %}<small class="text-muted d-block">Notes: {{ obs.notes|truncatewords:15 }}</small>{% endif %}
                
                {# ADDED: Display Image Thumbnails if they exist #}
                {% with obs_images=obs.images.all %}
                    {% if obs_images %}
                        <div class="mt-2 observation-images">
                            {% for img_obj in obs_images %}
                                {% if img_obj.image %} {# Check if image file exists #}
                                <img src="{{ img_obj.image.url }}" alt="Observation image {{ forloop.counter }}" class="img-thumbnail" style="height: 50px; width: auto; margin-right: 5px;">
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
            </li>
            {% empty %}
                <div id="observation-list-empty" class="card-body text-center text-muted">
                    No observations recorded yet for this session.
                </div>
            {% endfor %}
        </ul>
    </div>

  </div> {# End Right Column #}

</div> {# End Row #}

{# --- Safely pass data to JavaScript --- #}
{{ target_plants|default:0|json_script:"target-plants-data" }}
{{ completed_plants|default:0|json_script:"completed-plants-data" }}
{{ session.session_id|json_script:"session-id-data" }}
{{ latest_draft_json|default:"null"|json_script:"latest-draft-data" }}
{{ recommended_pests_ids|safe|json_script:"recommended-pests-json" }}
{{ recommended_diseases_ids|safe|json_script:"recommended-diseases-json" }}

{% endblock %}

{% block extra_js %}
{{ block.super }}
{# Add Leaflet JS if needed #}
{# <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script> #}

<script>
// Google solution for file upload
window.URL = window.URL || window.webkitURL;

const fileSelect = document.getElementById("fileSelect"),
    fileElem = document.getElementById("fileElem"),
    fileList = document.getElementById("fileList");

fileSelect.addEventListener("click", function (e) {
  if (fileElem) {
    fileElem.click();
  }
}, false);

// Process selected files
function handleFiles(files) {
  if (!files.length) {
    fileList.innerHTML = "<p>No files selected!</p>";
  } else {
    fileList.innerHTML = "";
    const list = document.createElement("ul");
    list.className = "list-group";
    fileList.appendChild(list);
    
    // Add each file to the form (hidden) and create a file list
    for (let i = 0; i < files.length; i++) {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      list.appendChild(li);
      
      const info = document.createElement("span");
      info.innerHTML = files[i].name + ": " + (files[i].size / 1024).toFixed(1) + " KB";
      li.appendChild(info);
      
      // Create image thumbnail
      const img = document.createElement("img");
      img.src = window.URL.createObjectURL(files[i]);
      img.height = 60;
      img.onload = function() {
        window.URL.revokeObjectURL(this.src);
      };
      li.prepend(img);
      
      // Show in gallery too
      const gallery = document.getElementById("gallery");
      if (gallery) {
        const imgContainer = document.createElement("div");
        imgContainer.className = "position-relative";
        
        const thumbImg = document.createElement("img");
        thumbImg.src = window.URL.createObjectURL(files[i]);
        thumbImg.className = "img-thumbnail";
        thumbImg.style.height = "100px";
        thumbImg.style.width = "auto";
        
        imgContainer.appendChild(thumbImg);
        gallery.appendChild(imgContainer);
      }
      
      // Add to form
      addFileToForm(files[i], "images");
    }
  }
}

// Add file to form function
function addFileToForm(file, fieldName) {
  // Create a hidden input field
  const input = document.createElement("input");
  input.type = "file";
  input.name = fieldName;
  input.style.display = "none";
  
  // Create a DataTransfer object and add the file
  const dataTransfer = new DataTransfer();
  dataTransfer.items.add(file);
  input.files = dataTransfer.files;
  
  // Add to the form
  document.getElementById("observation-form").appendChild(input);
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Active survey session page loaded - initializing...");
    // Store important DOM elements 
    const saveBtn = document.getElementById('save-observation-btn');
    const finishBtn = document.getElementById('finish-session-btn');
    const gpsStatus = document.getElementById('gps-status');
    const latInput = document.getElementById('id_latitude');
    const lonInput = document.getElementById('id_longitude');
    const accInput = document.getElementById('id_gps_accuracy');
    const form = document.getElementById('observation-form');
    const gpsErrorMessage = document.getElementById('gps-error-message');
    const saveStatusSpan = document.getElementById('save-status');
    const autoSaveStatusSpan = document.getElementById('auto-save-status');
    
    // Read data passed via json_script
    const targetPlants = JSON.parse(document.getElementById('target-plants-data').textContent);
    let completedPlants = JSON.parse(document.getElementById('completed-plants-data').textContent);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const observationList = document.getElementById('observation-list');
    const observationListEmpty = document.getElementById('observation-list-empty');
    const observationCountSpan = document.getElementById('observation-count');
    const completedObsCountSpan = document.getElementById('completed-obs-count');
    const uniquePestsCountSpan = document.getElementById('unique-pests-count');
    const uniqueDiseasesCountSpan = document.getElementById('unique-diseases-count');
    
    // Check for desktop testing mode right away
    const urlParams = new URLSearchParams(window.location.search);
    const isDesktopTesting = urlParams.get('force_desktop') === 'true';
    
    if (isDesktopTesting) {
        console.log('Desktop testing mode detected - enabling save button');
        if (saveBtn) {
            saveBtn.disabled = false;
        }
        
        // Set dummy GPS values if needed
        if (latInput) latInput.value = '34.052235';
        if (lonInput) lonInput.value = '-118.243683';
        if (accInput) accInput.value = '10.0';
        
        // Update GPS status display if it exists
        if (gpsStatus) {
            gpsStatus.classList.remove('alert-secondary', 'alert-warning', 'alert-danger');
            gpsStatus.classList.add('alert-success');
            const iconSpan = gpsStatus.querySelector('#gps-icon');
            const textSpan = gpsStatus.querySelector('#gps-text');
            if (iconSpan) iconSpan.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
            if (textSpan) textSpan.textContent = 'Desktop testing mode activated';
        }
    }

    // --- Function to add observation to list --- 
    function addObservationToList(obsData) {
        const list = document.getElementById('observation-list');
        const emptyMsg = document.getElementById('observation-list-empty');
        if (!list) return;

        // Hide empty message if it exists and is visible
        if (emptyMsg && emptyMsg.style.display !== 'none') {
            emptyMsg.style.display = 'none';
        }

        // Create list item element
        const li = document.createElement('li');
        li.classList.add('list-group-item');
        li.dataset.observationId = obsData.id;

        let content = `
            <strong>Time:</strong> ${obsData.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} 
            <small>(${parseFloat(obsData.latitude).toFixed(5)}, ${parseFloat(obsData.longitude).toFixed(5)})</small>
            <br>
        `;

        if (obsData.pests && obsData.pests.length > 0) {
            content += `Pests: ${obsData.pests.map(p => `<span class="badge bg-danger-subtle text-danger-emphasis me-1">${p.name}</span>`).join(' ')}<br>`;
        }
        if (obsData.diseases && obsData.diseases.length > 0) {
            content += `Diseases: ${obsData.diseases.map(d => `<span class="badge bg-warning-subtle text-warning-emphasis me-1">${d.name}</span>`).join(' ')}<br>`;
        }
        if (obsData.notes) {
            content += `<small class="text-muted d-block">Notes: ${obsData.notes}</small>`;
        }

        // Add Image Thumbnails
        if (obsData.images && obsData.images.length > 0) {
            content += '<div class="mt-2 observation-images">';
            obsData.images.forEach((img, index) => {
                content += `<img src="${img.url}" alt="Observation image ${index + 1}" class="img-thumbnail" style="height: 50px; width: auto; margin-right: 5px;">`;
            });
            content += '</div>';
        }

        li.innerHTML = content;

        // Add to the top of the list
        list.insertBefore(li, list.firstChild);
    }

    // --- Function to update UI elements (progress, finish button, counts) --- //
    function updateUI(newCounts = null) { // Accept optional counts object
        // Use live count or count from API response
        let currentCompleted = newCounts ? newCounts.completed : completedPlants;
        let currentPests = newCounts ? newCounts.unique_pests : parseInt(uniquePestsCountSpan?.textContent || '0');
        let currentDiseases = newCounts ? newCounts.unique_diseases : parseInt(uniqueDiseasesCountSpan?.textContent || '0');
        
        console.log(`Updating UI: Completed ${currentCompleted} / Target ${targetPlants}`);
        // Update progress bar text/width
        const progressBar = document.querySelector('.progress-bar');
        if (progressBar && targetPlants > 0) {
            const percentage = Math.min(100, Math.floor((currentCompleted / targetPlants) * 100)); // Cap at 100%
            progressBar.style.width = percentage + '%';
            progressBar.textContent = `${currentCompleted}/${targetPlants}`;
            // Add Bootstrap classes for color based on completion?
            progressBar.classList.remove('bg-success', 'bg-warning');
            if (percentage >= 100) {
                progressBar.classList.add('bg-success');
            } else if (percentage > 50) {
                 progressBar.classList.add('bg-warning');
            }
        }
        // Update completed count display
        if(completedObsCountSpan) completedObsCountSpan.textContent = currentCompleted;
        // Update unique pest/disease counts
        if(uniquePestsCountSpan) uniquePestsCountSpan.textContent = currentPests;
        if(uniqueDiseasesCountSpan) uniqueDiseasesCountSpan.textContent = currentDiseases;
        
        // Enable finish button if target met
        if (finishBtn && targetPlants > 0 && currentCompleted >= targetPlants) {
            finishBtn.disabled = false;
        } else if (finishBtn) {
            finishBtn.disabled = true;
        }
        // Update observation count in list header
        if (observationCountSpan) {
             observationCountSpan.textContent = currentCompleted;
        }
    }

    // 1. Get GPS Location (Initial check and subsequent checks)
    function getGPSLocation(initial = false) {
        // Check for desktop testing mode
        const urlParams = new URLSearchParams(window.location.search);
        const isDesktopTesting = urlParams.get('force_desktop') === 'true';
        
        // Handle desktop testing mode
        if (isDesktopTesting) {
            console.log('Desktop testing mode detected in getGPSLocation(), bypassing GPS requirements');
            
            // Set dummy values for testing if not already set
            const latInput = document.getElementById('id_latitude');
            const lonInput = document.getElementById('id_longitude');
            const accuracyInput = document.getElementById('id_gps_accuracy');
            const saveBtn = document.getElementById('save-observation-btn');
            
            if(latInput && !latInput.value) latInput.value = '34.052235';
            if(lonInput && !lonInput.value) lonInput.value = '-118.243683';
            if(accuracyInput && !accuracyInput.value) accuracyInput.value = '10.0';
            
            // Update GPS display
            updateGpsDisplay('ready', 'Desktop testing mode (dummy location)', 10.0);
            
            // Make sure the form is enabled
            enableForm();
            hideGpsError();
            
            // Directly enable the save button
            if (saveBtn) saveBtn.disabled = false;
            
            return; // Skip the actual GPS code
        }
        
        // Normal GPS acquisition for mobile devices
        if (!navigator.geolocation) {
            updateGpsDisplay('error', 'Geolocation not supported by your browser.');
            disableForm('GPS not available. Please use a device with GPS support.');
            return;
        }

        const latInput = document.getElementById('id_latitude');
        const lonInput = document.getElementById('id_longitude');
        const accuracyInput = document.getElementById('id_gps_accuracy');
        
        // If this is the initial check, show "acquiring" message
        if (initial) {
            updateGpsDisplay('waiting', 'Acquiring GPS signal...');
        }
        
        navigator.geolocation.getCurrentPosition(position => {
            // Success handler
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            console.log(`GPS Acquired: Lat: ${latitude}, Lon: ${longitude}, Acc: ${accuracy}m`);
            updateGpsDisplay('ready', '', accuracy);
            
            if(latInput) latInput.value = latitude.toFixed(9);
            if(lonInput) lonInput.value = longitude.toFixed(9);
            if(accuracyInput) accuracyInput.value = accuracy.toFixed(1);
            
            // Enable the form once we have a GPS location
            enableForm();
            hideGpsError(); // Hide any previous error
        }, error => {
            // Error handler
            let errorMsg = "GPS Error: ";
            switch(error.code) {
                case error.PERMISSION_DENIED: errorMsg += "Location permission denied."; break;
                case error.POSITION_UNAVAILABLE: errorMsg += "Location information unavailable."; break;
                case error.TIMEOUT: errorMsg += "Location request timed out."; break;
                default: errorMsg += "An unknown error occurred."; break;
            }
            updateGpsDisplay('error', errorMsg);
            showGpsError(errorMsg); // Show persistent error
            console.error(errorMsg);
            
            // Check again if we're in desktop mode before disabling form
            if (!isDesktopTesting) {
                disableForm(errorMsg);
            } else {
                console.log('GPS error, but in desktop testing mode, so keeping form enabled');
                enableForm();
            }
        }, {
            enableHighAccuracy: true, // Request high accuracy
            timeout: 10000, // 10 second timeout
            maximumAge: 30000 // Accept a position no older than 30 seconds
        });
    }

    // --- Function for debounced auto-save --- 
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    async function autoSaveObservation() {
        if (!form) return;
        console.log('Attempting auto-save...');
        autoSaveStatusSpan.textContent = 'Saving draft...';
        autoSaveStatusSpan.className = 'ms-2 text-info small';

        // Create FormData directly from the form
        const formData = new FormData(form);
        
        // Set plant_sequence_number to a valid value if empty to avoid validation errors
        const plantSeqNum = formData.get('plant_sequence_number');
        if (!plantSeqNum || plantSeqNum === '') {
            formData.set('plant_sequence_number', '999'); // Use temporary value for draft
        }
        
        // Ensure session_id is included
        if (!formData.has('session_id')) {
            formData.append('session_id', JSON.parse(document.getElementById('session-id-data').textContent));
        }

        try {
            const response = await fetch('{% url "core:api_auto_save_observation" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Important for Django request.is_ajax()
                }
            });

            if (response.ok) {
                const result = await response.json();
                console.log('Auto-save successful:', result);
                autoSaveStatusSpan.textContent = 'Draft saved.';
                autoSaveStatusSpan.className = 'ms-2 text-success small';
                
                // Store the draft ID for future updates
                if (result.draft_id) {
                    form.dataset.draftId = result.draft_id;
                }
            } else {
                console.error('Auto-save failed:', response.status, await response.text());
                autoSaveStatusSpan.textContent = 'Error saving draft.';
                autoSaveStatusSpan.className = 'ms-2 text-danger small';
            }
        } catch (error) {
            console.error('Network error during auto-save:', error);
            autoSaveStatusSpan.textContent = 'Network error saving draft.';
            autoSaveStatusSpan.className = 'ms-2 text-danger small';
        }
    }

    const debouncedAutoSave = debounce(autoSaveObservation, 2000);

    // --- Load Draft Data Function --- 
    function loadDraftData(draft) {
         if (!draft || !form) return;
         console.log('Loading draft data:', draft);

         // Store draft ID for future updates
         if (draft.id) {
             form.dataset.draftId = draft.id;
         }

         // Plant Sequence Number (only for completed observations)
         const plantSeqInput = document.getElementById('id_plant_sequence_number');
         if (plantSeqInput && draft.plant_sequence_number && draft.plant_sequence_number !== '999') {
             plantSeqInput.value = draft.plant_sequence_number;
         }

         // Pests Observed (Checkboxes)
         if (draft.pests_observed && Array.isArray(draft.pests_observed)) {
             draft.pests_observed.forEach(pestId => {
                 const checkbox = form.querySelector(`input[name="pests_observed"][value="${pestId}"]`);
                 if (checkbox) checkbox.checked = true;
             });
         }

         // Diseases Observed (Checkboxes)
         if (draft.diseases_observed && Array.isArray(draft.diseases_observed)) {
             draft.diseases_observed.forEach(diseaseId => {
                 const checkbox = form.querySelector(`input[name="diseases_observed"][value="${diseaseId}"]`);
                 if (checkbox) checkbox.checked = true;
             });
         }

         // Notes
         const notesInput = form.querySelector('#id_notes');
         if (notesInput && draft.notes) {
             notesInput.value = draft.notes;
             // Ensure notes section is visible if there are notes
             const notesCollapse = document.getElementById('collapseNotes');
             if (notesCollapse && !notesCollapse.classList.contains('show')) {
                 const bsCollapse = new bootstrap.Collapse(notesCollapse);
                 bsCollapse.show();
             }
         }
         
         // Set GPS values if present
         if (draft.latitude && draft.longitude) {
             const latInput = document.getElementById('id_latitude');
             const lonInput = document.getElementById('id_longitude');
             const accInput = document.getElementById('id_gps_accuracy');
             
             if (latInput) latInput.value = draft.latitude;
             if (lonInput) lonInput.value = draft.longitude;
             if (accInput && draft.gps_accuracy) accInput.value = draft.gps_accuracy;
             
             // Update GPS display if loaded from draft
             updateGpsDisplay('ready', '', draft.gps_accuracy ? parseFloat(draft.gps_accuracy) : 10);
         }
         
         autoSaveStatusSpan.textContent = 'Draft loaded.'; // Indicate draft loaded
         autoSaveStatusSpan.className = 'ms-2 text-muted small';
    }

    // --- UI Enhancement Functions --- //
    function highlightRecommendedItems() {
        try {
            // Get the recommended pest and disease IDs from the JSON script tags
            const recommendedPestIds = JSON.parse(document.getElementById('recommended-pests-json').textContent || '[]');
            const recommendedDiseaseIds = JSON.parse(document.getElementById('recommended-diseases-json').textContent || '[]');
            
            console.log('Highlighting recommended pests:', recommendedPestIds);
            console.log('Highlighting recommended diseases:', recommendedDiseaseIds);

            // Highlight recommended pests
            document.querySelectorAll('input[name="pests_observed"]').forEach(input => {
                if (recommendedPestIds.includes(parseInt(input.value))) {
                    const label = input.closest('label') || input.parentElement;
                    if (label) {
                        label.insertAdjacentHTML('beforeend', ' <span class="badge bg-info-subtle text-info-emphasis">Recommended</span>');
                    }
                }
            });

            // Highlight recommended diseases
            document.querySelectorAll('input[name="diseases_observed"]').forEach(input => {
                if (recommendedDiseaseIds.includes(parseInt(input.value))) {
                    const label = input.closest('label') || input.parentElement;
                    if (label) {
                        label.insertAdjacentHTML('beforeend', ' <span class="badge bg-info-subtle text-info-emphasis">Recommended</span>');
                    }
                }
            });
        } catch (error) {
            console.error("Error highlighting recommended items:", error);
        }
    }

    function updateGpsDisplay(status, message = '', accuracy = null) {
        const statusDiv = document.getElementById('gps-status');
        const iconSpan = document.getElementById('gps-icon');
        const textSpan = document.getElementById('gps-text');
        
        if (!statusDiv || !iconSpan || !textSpan) return;

        // Reset classes
        statusDiv.classList.remove('alert-secondary', 'alert-warning', 'alert-success', 'alert-danger');

        switch (status) {
            case 'waiting':
                statusDiv.classList.add('alert-warning');
                iconSpan.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                textSpan.textContent = message || 'Acquiring GPS signal...';
                break;
            case 'ready':
                statusDiv.classList.add('alert-success');
                iconSpan.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
                textSpan.textContent = `GPS Ready. Accuracy: ${accuracy !== null ? accuracy.toFixed(1) + 'm' : 'N/A'}`;
                break;
            case 'error':
                statusDiv.classList.add('alert-danger');
                iconSpan.innerHTML = '<i class="bi bi-x-octagon-fill"></i>';
                textSpan.textContent = message || 'GPS Error.';
                break;
            default:
                statusDiv.classList.add('alert-secondary');
                iconSpan.innerHTML = '<i class="bi bi-question-circle"></i>';
                textSpan.textContent = 'GPS status unknown.';
        }
    }

    // --- Helper functions to enable/disable form ---
    function disableForm(reason) {
        // Check if we're in desktop testing mode
        const urlParams = new URLSearchParams(window.location.search);
        const isDesktopTesting = urlParams.get('force_desktop') === 'true';
        
        if (isDesktopTesting) {
            console.log("Desktop testing mode active - not disabling form despite reason: " + reason);
            // Just show the reason but keep the form enabled
            if (gpsErrorMessage) {
                gpsErrorMessage.textContent = "Desktop testing mode: " + reason + " (form remains enabled)";
                gpsErrorMessage.style.display = 'block';
            }
            return;
        }
        
        // Normal behavior for mobile
        if (saveBtn) saveBtn.disabled = true;
        
        // Disable checkboxes and textareas, but NOT hidden fields or file inputs
        if (form) {
            form.querySelectorAll('input[type="checkbox"], textarea').forEach(el => {
                el.disabled = true;
            });
        }
        
        showGpsError(reason);
        if (gpsStatus) gpsStatus.style.display = 'none'; // Hide the status spinner area
        console.warn("Form disabled: " + reason);
    }

    function enableForm() {
        if (saveBtn) saveBtn.disabled = false;
        
        // Enable all interactive form elements
        if (form) {
            form.querySelectorAll('input[type="checkbox"], textarea').forEach(el => {
                el.disabled = false;
            });
        }
        
        hideGpsError();
        if (gpsStatus) gpsStatus.style.display = 'block'; // Show status area again
        console.log("Form enabled.");
    }

    function showGpsError(message) {
        if(gpsErrorMessage) {
            gpsErrorMessage.textContent = message;
            gpsErrorMessage.style.display = 'block';
        }
    }

    function hideGpsError() {
        if(gpsErrorMessage) {
            gpsErrorMessage.style.display = 'none';
        }
    }

    // --- Initialize page ---
    if (form) {
        getGPSLocation(true); // Initial GPS check

        try {
            loadDraftData(JSON.parse(document.getElementById('latest-draft-data').textContent)); // Load draft data
        } catch (e) {
            console.error("Error loading draft data:", e);
        }

        // Attach auto-save listeners to form inputs
        form.querySelectorAll('input, textarea, select').forEach(element => {
            // Exclude file input from triggering auto-save
            if (element.type !== 'file' && element.name !== 'csrfmiddlewaretoken') {
                element.addEventListener('input', debouncedAutoSave);
                element.addEventListener('change', debouncedAutoSave); // For checkboxes/selects
            }
        });

        // Handle form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Form submitted');
            
            const saveButton = document.getElementById('save-observation-btn');
            const spinner = saveButton.querySelector('.spinner-border');
            const buttonTextSpan = saveButton.querySelector('.button-text');
            const buttonIcon = saveButton.querySelector('.bi-check-lg');
            const saveStatus = document.getElementById('save-status');

            // Get the next plant sequence number automatically
            const existingObservations = document.querySelectorAll('#observation-list > li').length;
            const nextSequenceNumber = existingObservations + 1;
            
            // Set the plant_sequence_number field
            document.getElementById('id_plant_sequence_number').value = nextSequenceNumber;
            console.log(`Setting plant sequence number to: ${nextSequenceNumber}`);

            // Disable button and show spinner
            saveButton.disabled = true;
            if (spinner) spinner.style.display = 'inline-block';
            if (buttonTextSpan) buttonTextSpan.textContent = 'Saving...';
            if (buttonIcon) buttonIcon.style.display = 'none';
            if (saveStatus) saveStatus.textContent = '';

            try {
                // Create form data from the form
                const formData = new FormData(form);
                
                // Include draft ID if we have one
                if (form.dataset.draftId) {
                    formData.append('draft_id', form.dataset.draftId);
                }
                
                // Ensure session ID is included
                if (!formData.has('session_id')) {
                    formData.append('session_id', JSON.parse(document.getElementById('session-id-data').textContent));
                }

                // Make the API call
                const response = await fetch('{% url "core:api_create_observation" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Observation saved successfully:', result);
                    
                    // Update UI with the new observation
                    if (saveStatus) {
                        saveStatus.textContent = 'Saved successfully!';
                        saveStatus.className = 'ms-2 text-success';
                    }
                    
                    // Check if we got a valid result with observation data
                    if (result.status === 'success' && result.observation) {
                        // Add to list and update counts
                        addObservationToList(result.observation);
                        if (result.counts) {
                            updateUI(result.counts);
                        }
                        
                        // Reset form
                        form.reset();
                        
                        // Clear stored draft ID
                        delete form.dataset.draftId;
                        
                        // Clear image displays
                        if (document.getElementById('gallery')) {
                            document.getElementById('gallery').innerHTML = '';
                        }
                        if (document.getElementById('fileList')) {
                            document.getElementById('fileList').innerHTML = '<p>No files selected!</p>';
                        }
                        
                        setTimeout(() => { 
                            if (saveStatus) saveStatus.textContent = ''; 
                        }, 3000);
                    } else {
                        console.error('Unexpected response format:', result);
                        if (saveStatus) {
                            saveStatus.textContent = result.message || 'Error: Unexpected response format';
                            saveStatus.className = 'ms-2 text-danger';
                        }
                    }
                } else {
                    // Handle error response
                    console.error('Error saving observation:', response.status);
                    try {
                        const errorData = await response.json();
                        console.error('Error details:', errorData);
                        if (errorData.errors) {
                            if (saveStatus) {
                                saveStatus.textContent = 'Form has errors. Please check and try again.';
                                saveStatus.className = 'ms-2 text-danger';
                            }
                        } else {
                            if (saveStatus) {
                                saveStatus.textContent = errorData.message || 'Error saving observation';
                                saveStatus.className = 'ms-2 text-danger';
                            }
                        }
                    } catch (jsonError) {
                        if (saveStatus) {
                            saveStatus.textContent = 'Error saving observation';
                            saveStatus.className = 'ms-2 text-danger';
                        }
                    }
                }
            } catch (error) {
                console.error('Error saving observation:', error);
                if (saveStatus) {
                    saveStatus.textContent = `Error: ${error.message || 'Network error'}`;
                    saveStatus.className = 'ms-2 text-danger';
                }
            } finally {
                // Restore button state
                saveButton.disabled = false;
                if (spinner) spinner.style.display = 'none';
                if (buttonTextSpan) buttonTextSpan.textContent = 'Save Observation at Current Location';
                if (buttonIcon) buttonIcon.style.display = 'inline-block';
            }
        });
    } else {
        console.error('Observation form not found');
    }
    
    // Initialize UI components
    updateUI();
    highlightRecommendedItems();
});
</script>
{% endblock extra_js %}