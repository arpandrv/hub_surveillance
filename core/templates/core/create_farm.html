{% extends 'core/base.html' %}

{% block title %}{% if farm %}Edit Farm: {{ farm.name }}{% else %}Create Farm{% endif %}{% endblock %}

{% block heading %}{# No main heading needed here #}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <div class="card shadow-sm mb-4">
            <div class="card-header text-white" style="background-color: #0d6efd;">
                <h4 class="mb-0">{% if farm %}Edit Farm{% else %}Create Farm{% endif %}</h4>
            </div>
            <div class="card-body">
                <form method="post" novalidate id="farm-form">
                    {% csrf_token %}
                    
                    {# Hidden input to store selected Geoscape ID #}
                    <input type="hidden" name="geoscape_address_id" id="id_geoscape_address_id" value="{{ form.instance.geoscape_address_id|default:'' }}">
                    {# Hidden input to store the full selected address text #}
                    <input type="hidden" name="formatted_address" id="id_formatted_address" value="{{ form.instance.formatted_address|default:'' }}">

                    {# Display non-field errors #}
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger small">
                        {% for error in form.non_field_errors %}
                        <p class="mb-0">{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {# Farm Name #}
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">{{ form.name.label }}:</label>
                        <input type="text" name="{{ form.name.name }}" id="{{ form.name.id_for_label }}" class="form-control {% if form.name.errors %}is-invalid{% endif %}" value="{{ form.name.value|default:'' }}" required>
                        {% if form.name.errors %}<div class="invalid-feedback">{{ form.name.errors|striptags }}</div>{% endif %}
                    </div>

                    {# Region - Needed for API call #}
                    <div class="mb-3">
                        <label for="{{ form.region.id_for_label }}" class="form-label fw-bold">{{ form.region.label }}:</label>
                        <select name="{{ form.region.name }}" id="{{ form.region.id_for_label }}" class="form-select {% if form.region.errors %}is-invalid{% endif %}" required>
                            {# Value comes from the form queryset #}
                            {% for value, text in form.region.field.choices %}
                            <option value="{{ value }}" {% if form.region.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ text }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Only regions relevant to Northern Australia are shown.</div>
                        {% if form.region.errors %}<div class="invalid-feedback">{{ form.region.errors|striptags }}</div>{% endif %}
                    </div>

                    {# Address Toggle Checkbox #}
                    <div class="mb-3 form-check">
                        {# Use the model field value for initial state #}
                        <input type="checkbox" name="has_exact_address" id="id_has_exact_address" class="form-check-input" {% if form.instance.has_exact_address %}checked{% endif %}>
                        <label for="id_has_exact_address" class="form-check-label fw-bold">Do you have an exact street address for this farm?</label>
                    </div>

                    {# Address Search Input and Suggestions - Shown/Hidden by JS #}
                    <div class="mb-3" id="exact-address-section" style="display: none;"> {# Initially hidden #}
                        <label for="address_search_input" class="form-label fw-bold">Enter Street Address:</label>
                        <input type="text" id="address_search_input" class="form-control" placeholder="Start typing address..." autocomplete="off" value="{{ form.instance.formatted_address|default:'' }}">
                         <div id="suggestions_list" class="list-group mt-1 position-absolute" style="z-index: 1000;">
                            {# Suggestions will be loaded here by JS #}
                        </div>
                        <div class="form-text">Select a suggested address to automatically parse details.</div>
                    </div>

                     {# General Location Section - Shown/Hidden by JS #}
                    <div id="general-location-section" style="display: block;"> {# Initially shown #}
                        <div class="alert alert-secondary small mb-3" role="alert">
                            No problem! You can map your farm's boundary precisely using GPS later via the 'Map Boundary' option on the farm details page. For now, you can leave the address field blank or add a general location description below if you wish.
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.location_description.id_for_label }}" class="form-label fw-bold">{{ form.location_description.label }}:</label>
                            <textarea name="{{ form.location_description.name }}" id="{{ form.location_description.id_for_label }}" class="form-control {% if form.location_description.errors %}is-invalid{% endif %}" rows="2" placeholder="{{ form.location_description.field.widget.attrs.placeholder }}">{{ form.location_description.value|default:'' }}</textarea>
                            <div class="form-text">e.g., "Near Katherine River", "Smith Property via XYZ Road"</div>
                            {% if form.location_description.errors %}<div class="invalid-feedback">{{ form.location_description.errors|striptags }}</div>{% endif %}
                        </div>
                    </div>

                    {# Size and Stocking Rate #}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.size_hectares.id_for_label }}" class="form-label fw-bold">{{ form.size_hectares.label }}:</label>
                            <input type="number" name="{{ form.size_hectares.name }}" id="{{ form.size_hectares.id_for_label }}" class="form-control {% if form.size_hectares.errors %}is-invalid{% endif %}" value="{{ form.size_hectares.value|default:'' }}" step="any">
                             <div class="form-text">Total farm size in hectares</div>
                            {% if form.size_hectares.errors %}<div class="invalid-feedback">{{ form.size_hectares.errors|striptags }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                             <label for="{{ form.stocking_rate.id_for_label }}" class="form-label fw-bold">{{ form.stocking_rate.label }}:</label>
                            <input type="number" name="{{ form.stocking_rate.name }}" id="{{ form.stocking_rate.id_for_label }}" class="form-control {% if form.stocking_rate.errors %}is-invalid{% endif %}" value="{{ form.stocking_rate.value|default:'' }}" step="1">
                            <div class="form-text">Number of plants per hectare</div>
                            {% if form.stocking_rate.errors %}<div class="invalid-feedback">{{ form.stocking_rate.errors|striptags }}</div>{% endif %}
                        </div>
                    </div>

                    {# Distribution Pattern #}
                     <div class="mb-3">
                        <label for="{{ form.distribution_pattern.id_for_label }}" class="form-label fw-bold">Plant Distribution Pattern:</label>
                        <select name="{{ form.distribution_pattern.name }}" id="{{ form.distribution_pattern.id_for_label }}" class="form-select {% if form.distribution_pattern.errors %}is-invalid{% endif %}">
                            {% for value, text in form.distribution_pattern.field.choices %}
                            <option value="{{ value }}" {% if form.distribution_pattern.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ text }}</option>
                            {% endfor %}
                        </select>
                        {% if form.distribution_pattern.errors %}<div class="invalid-feedback">{{ form.distribution_pattern.errors|striptags }}</div>{% endif %}
                    </div>
                    
                    {# Plant Types (Display Only - Set in View) #}
                     <div class="mb-3">
                        <label class="form-label fw-bold">Plant Types:</label>
                        <div class="form-control bg-light">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="mangoCheck" checked disabled>
                                <label class="form-check-label" for="mangoCheck">
                                    Mango
                                </label>
                            </div>
                        </div>
                        <div class="form-text">Currently only Mango surveillance is supported.</div>
                    </div>

                    {# Buttons #}
                    <hr class="my-4">
                    <div class="d-flex justify-content-end">
                         {% if farm %}
                            <a href="{% url 'core:farm_detail' farm.id %}" class="btn btn-outline-secondary me-2">Cancel</a>
                         {% else %}
                            <a href="{% url 'core:myfarms' %}" class="btn btn-outline-secondary me-2">Cancel</a> {# Point cancel to myfarms #}
                         {% endif %}
                        <button type="submit" class="btn btn-primary">{% if farm %}Save Farm{% else %}Save Farm{% endif %}</button> 
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addressCheckbox = document.getElementById('id_has_exact_address');
    const exactAddressSection = document.getElementById('exact-address-section');
    const generalLocationSection = document.getElementById('general-location-section');
    const addressSearchInput = document.getElementById('address_search_input');
    const suggestionsList = document.getElementById('suggestions_list');
    const regionSelect = document.getElementById('{{ form.region.id_for_label }}');
    const geoscapeIdInput = document.getElementById('id_geoscape_address_id');
    const formattedAddressInput = document.getElementById('id_formatted_address');
    let debounceTimer; // For debouncing API calls

    function toggleAddressFields() {
        if (addressCheckbox.checked) {
            exactAddressSection.style.display = 'block';
            generalLocationSection.style.display = 'none';
        } else {
            exactAddressSection.style.display = 'none';
            generalLocationSection.style.display = 'block';
            // Clear search and hidden fields if checkbox is unchecked
            addressSearchInput.value = ''; 
            geoscapeIdInput.value = '';
            formattedAddressInput.value = '';
            suggestionsList.innerHTML = ''; // Clear suggestions
        }
    }

    async function fetchSuggestions() {
        const query = addressSearchInput.value;
        const regionId = regionSelect.value;
        suggestionsList.innerHTML = ''; // Clear previous suggestions
        geoscapeIdInput.value = ''; // Clear hidden ID unless a suggestion is selected
        formattedAddressInput.value = '';

        if (query.length < 3 || !regionId) {
            suggestionsList.innerHTML = '<li class="list-group-item text-muted">Please select a region and type at least 3 characters.</li>';
            return; // Don't search if query too short or no region
        }

        const url = `{% url 'core:api_address_suggestions' %}?query=${encodeURIComponent(query)}&region_id=${encodeURIComponent(regionId)}`;

        try {
            suggestionsList.innerHTML = '<li class="list-group-item text-muted">Searching...</li>'; // Indicate loading
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            suggestionsList.innerHTML = ''; // Clear loading/previous message

            if (data.error) {
                console.error('API Error:', data.error);
                suggestionsList.innerHTML = `<li class="list-group-item text-danger">${data.error}</li>`;
            } else if (data.suggestions && data.suggestions.length > 0) {
                data.suggestions.forEach(item => {
                    const li = document.createElement('a'); // Use anchor for better semantics
                    li.href = '#'; // Prevent page jump
                    li.classList.add('list-group-item', 'list-group-item-action');
                    li.textContent = item.address;
                    li.dataset.id = item.id; // Store ID in data attribute
                    li.dataset.address = item.address;
                    li.addEventListener('click', function(e) {
                        e.preventDefault(); // Prevent anchor default action
                        addressSearchInput.value = this.dataset.address; // Set input to full address
                        geoscapeIdInput.value = this.dataset.id; // Store the ID
                        formattedAddressInput.value = this.dataset.address; // Store full address
                        suggestionsList.innerHTML = ''; // Clear suggestions after selection
                    });
                    suggestionsList.appendChild(li);
                });
            } else {
                suggestionsList.innerHTML = '<li class="list-group-item text-muted">No suggestions found.</li>';
            }
        } catch (error) {
            console.error('Fetch Error:', error);
            suggestionsList.innerHTML = '<li class="list-group-item text-danger">Error fetching suggestions. Check console.</li>';
        }
    }

    // Initial state based on checkbox value
    if (addressCheckbox) {
        // Ensure DOM is fully loaded before toggling
        setTimeout(function() {
            toggleAddressFields();
            console.log('Address checkbox state:', addressCheckbox.checked);
            console.log('Address section visibility:', exactAddressSection.style.display);
        }, 100);
        addressCheckbox.addEventListener('change', function() {
            toggleAddressFields();
            console.log('Address checkbox changed to:', addressCheckbox.checked);
            console.log('Address section visibility now:', exactAddressSection.style.display);
        });
    }

    // Event listener for address input with debouncing
    if (addressSearchInput && regionSelect) {
        addressSearchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            // Don't fetch if a geoscape ID is already selected (means user picked one)
            if (!geoscapeIdInput.value) { 
                 debounceTimer = setTimeout(fetchSuggestions, 300); // Wait 300ms after user stops typing
            } else {
                 // If user starts typing again after selecting, clear the selected ID
                 geoscapeIdInput.value = '';
                 formattedAddressInput.value = '';
                 debounceTimer = setTimeout(fetchSuggestions, 300);
            }
        });
        
        // Also fetch suggestions if region changes while address field has text
        regionSelect.addEventListener('change', function(){
             if (addressSearchInput.value.length >= 3 && !geoscapeIdInput.value) {
                 fetchSuggestions();
             }
        });

        // Clear suggestions when input loses focus (optional)
        document.addEventListener('click', function(event) {
            // Check if the click is outside the search input and suggestion list
            if (!addressSearchInput.contains(event.target) && !suggestionsList.contains(event.target)) {
                suggestionsList.innerHTML = ''; // Clear suggestions
            }
        });

    }
});
</script>
{% endblock %} 