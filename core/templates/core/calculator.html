{% extends 'core/base.html' %}

{% block title %}Surveillance Calculator{% endblock %}
{% block heading %}Surveillance Calculator{% endblock %}

{% block content %}
<div class="row">
    {# Left Side: Form #}
    <div class="col-md-5">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Calculate Sample Size</h5>
            </div>
            <div class="card-body">
                {# Display auto-detected stage and prevalence #}
                {% if current_stage and current_prevalence_p is not None %}
                <div class="alert alert-info small mb-3">
                    <i class="bi bi-info-circle-fill me-1"></i>
                    The current farming stage is automatically detected as <strong>{{ current_stage }}</strong>, 
                    with an estimated prevalence of <strong>{{ current_prevalence_p }}%</strong> used for this calculation.
                </div>
                {% endif %}
                
                <form method="get" action="{% url 'core:calculator' %}" novalidate>
                    {# Removed csrf_token as it's a GET request #}

                    {# Farm Selection #}
                    <div class="mb-3">
                        <label for="{{ form.farm.id_for_label }}" class="form-label fw-bold">{{ form.farm.label }}:</label>
                        {{ form.farm }}
                        {% if form.farm.errors %}<div class="text-danger small mt-1">{{ form.farm.errors|striptags }}</div>{% endif %}
                    </div>

                    {# Confidence Level #}
                    <div class="mb-3">
                        <label for="{{ form.confidence_level.id_for_label }}" class="form-label fw-bold">{{ form.confidence_level.label }}:</label>
                        {{ form.confidence_level }}
                        {% if form.confidence_level.errors %}<div class="text-danger small mt-1">{{ form.confidence_level.errors|striptags }}</div>{% endif %}
                    </div>

                    {# REMOVED Season Selection #}
                    {# The season field was previously here and has been removed. #}

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-calculator me-1"></i> Calculate
                    </button>
                </form>
            </div>
        </div>
    </div>

    {# Right Side: Results #}
    <div class="col-md-7">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Calculation Results</h5>
            </div>
            <div class="card-body">
                {% if form_submitted and calculation_results and not calculation_results.error %}
                    {# Display Calculation Parameters #}
                    <div class="mb-3 pb-2 border-bottom">
                        <h6 class="mb-1">Calculation Parameters:</h6>
                        <ul class="list-unstyled small text-muted mb-0">
                            <li><i class="bi bi-geo-alt-fill me-1 text-secondary"></i>Farm: <strong>{{ selected_farm.name }}</strong> ({{ calculation_results.N }} plants)</li>
                            <li><i class="bi bi-calendar-check-fill me-1 text-secondary"></i>Stage: <strong>{{ current_stage }}</strong> ({{ current_prevalence_p }}% prevalence)</li>
                            <li><i class="bi bi-shield-check me-1 text-secondary"></i>Confidence: <strong>{{ calculation_results.confidence_level_percent }}%</strong></li>
                        </ul>
                    </div>

                    {# Display Main Result #}
                    <div class="text-center mb-3">
                        <p class="fs-5 mb-0 text-muted">Recommended plants to survey:</p>
                        <p class="display-4 fw-bold text-success mb-1">{{ calculation_results.required_plants_to_survey }}</p>
                    </div>
                    
                    {# Display Percentage and Progress Bar #}
                    {% if calculation_results.percentage_of_total is not None %}
                    <div class="progress mb-1 mx-auto" style="height: 10px; max-width: 300px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ calculation_results.percentage_of_total }}%;" 
                             aria-valuenow="{{ calculation_results.percentage_of_total }}" 
                             aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <p class="text-center text-muted small mb-3">({{ calculation_results.percentage_of_total|floatformat:1 }}% of total)</p>
                    {% endif %}
                    
                    {# Display Survey Frequency Badge #}
                    {% if calculation_results.survey_frequency %}
                    <div class="text-center mb-3">
                        <span class="badge bg-info-subtle text-info-emphasis p-2 fs-6 border border-info-subtle">
                             <i class="bi bi-search me-1"></i> Inspect approx. 1 in every {{ calculation_results.survey_frequency }} plants
                        </span>
                    </div>
                    {% endif %}
                    
                    {# Link to Farm Detail #}
                    <div class="text-center border-top pt-3 mt-3">
                        <a href="{% url 'core:farm_detail' farm_id=selected_farm.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye"></i> View Farm Details & Recommendations
                        </a>
                    </div>

                {% elif form_submitted and calculation_results.error %}
                    <div class="alert alert-danger">
                        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Calculation Error</h5>
                        <p>{{ calculation_results.error }}</p>
                        <p class="mb-0">Please check the farm details (total plants must be positive) and try again.</p>
                    </div>
                {% else %}
                    <p class="text-muted text-center pt-3">Select a farm and confidence level to calculate the required sample size.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %} 